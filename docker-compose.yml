# KiroGate - Docker Compose é…ç½®
#
# ä½¿ç”¨æ–¹æ³•:
#   1. å¤åˆ¶ .env.example ä¸?.env å¹¶é…ç½?
#   2. docker-compose up -d
#
# æˆ–è€…ç›´æ¥ä¼ å…¥ç¯å¢ƒå˜é‡?
#   PROXY_API_KEY=your-key REFRESH_TOKEN=your-token docker-compose up -d

services:
  kirogate:
    build: .
    container_name: kirogate
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # å¿…å¡«: ä»£ç†æœåŠ¡å™¨å¯†ç ?
      - PROXY_API_KEY=${PROXY_API_KEY:-changeme}

      # æ–¹å¼ä¸€: ä½¿ç”¨ refresh token (æ¨èç”¨äº Docker)
      - REFRESH_TOKEN=${REFRESH_TOKEN:-}

      # æ–¹å¼äº? æŒ‚è½½å‡­è¯æ–‡ä»¶ (è§ä¸‹æ–?volumes)
      - KIRO_CREDS_FILE=${KIRO_CREDS_FILE:-}

      # å¯é€‰é…ç½?
      - PROFILE_ARN=${PROFILE_ARN:-}
      - KIRO_REGION=${KIRO_REGION:-us-east-1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # è¶…æ—¶é…ç½®
      - FIRST_TOKEN_TIMEOUT=${FIRST_TOKEN_TIMEOUT:-45}
      - FIRST_TOKEN_MAX_RETRIES=${FIRST_TOKEN_MAX_RETRIES:-5}

      # è°ƒè¯•æ¨¡å¼
      - DEBUG_MODE=${DEBUG_MODE:-off}

      # Admin ç®¡ç†åå°
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - ADMIN_SECRET_KEY=${ADMIN_SECRET_KEY:-change-me-in-production}

      # OAuth2 ç”¨æˆ·ç™»å½•ï¼ˆå¯é€‰ï¼‰
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID:-}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-}
      - OAUTH_REDIRECT_URI=${OAUTH_REDIRECT_URI:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-}

      # ç”¨æˆ·ç³»ç»Ÿé…ç½®
      - USER_SESSION_SECRET=${USER_SESSION_SECRET:-change-me-in-production}
      - TOKEN_ENCRYPT_KEY=${TOKEN_ENCRYPT_KEY:-change-me-32-bytes-key!!}

      # é™æ€èµ„æºä»£ç†é…ç½?
      - STATIC_ASSETS_PROXY_ENABLED=${STATIC_ASSETS_PROXY_ENABLED:-true}
      - STATIC_ASSETS_PROXY_BASE=${STATIC_ASSETS_PROXY_BASE:-https://proxy.jhun.edu.kg}

    volumes:
      # æŒä¹…åŒ–ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨å‘½åå·ï¼Œè‡ªåŠ¨å¤„ç†æƒé™ï¼?
      - kirogate_data:/app/data
      # å¦‚æœä½¿ç”¨å‡­è¯æ–‡ä»¶ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
      # - ~/.aws/sso/cache/kiro-auth-token.json:/app/credentials.json:ro
      # ç„¶åè®¾ç½® KIRO_CREDS_FILE=/app/credentials.json

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  kirogate_data:
