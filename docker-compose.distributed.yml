# KiroGate - åˆ†å¸ƒå¼éƒ¨ç½?Docker Compose é…ç½®
#
# ä½¿ç”¨æ–¹æ³•:
#   1. å¤åˆ¶ .env.example ä¸?.env å¹¶é…ç½®æ‰€æœ‰å¿…å¡«é¡¹
#   2. docker compose -f docker-compose.distributed.yml up -d --scale kirogate=3
#
# å‰¯æœ¬æ•°è°ƒæ•?
#   docker compose -f docker-compose.distributed.yml up -d --scale kirogate=5
#
# å¿…å¡«ç¯å¢ƒå˜é‡:
#   - PROXY_API_KEY: ä»£ç†æœåŠ¡å™¨å¯†ç ?
#   - ADMIN_PASSWORD: ç®¡ç†åå°å¯†ç 
#   - ADMIN_SECRET_KEY: ç®¡ç†åå°ç­¾åå¯†é’¥ï¼ˆåˆ†å¸ƒå¼æ¨¡å¼å¿…é¡»ä¿®æ”¹é»˜è®¤å€¼ï¼‰
#   - USER_SESSION_SECRET: ç”¨æˆ·ä¼šè¯ç­¾åå¯†é’¥ï¼ˆåˆ†å¸ƒå¼æ¨¡å¼å¿…é¡»ä¿®æ”¹é»˜è®¤å€¼ï¼‰
#   - TOKEN_ENCRYPT_KEY: Token åŠ å¯†å¯†é’¥ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä¸€è‡´ï¼‰

services:
  # ============================================================
  # PostgreSQL - å…±äº«æŒä¹…åŒ–å­˜å‚?
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: kirogate-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: kirogate
      POSTGRES_USER: kirogate
      POSTGRES_PASSWORD: ${PG_PASSWORD:-changeme}
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kirogate"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================
  # Redis - åˆ†å¸ƒå¼ç¼“å­?é”?è®¡æ•°å™?
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: kirogate-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================
  # KiroGate åº”ç”¨æœåŠ¡ - å¤šå‰¯æœ?
  # ============================================================
  kirogate:
    build: .
    restart: unless-stopped
    # ä½¿ç”¨ docker compose up --scale kirogate=3 æ¥è®¾ç½®å‰¯æœ¬æ•°
    # é»˜è®¤å¯åŠ¨ 1 ä¸ªå®ä¾‹ï¼Œé€šè¿‡ --scale å‚æ•°å¯ä»¥æ‰©å±•åˆ°å¤šä¸ªå‰¯æœ?
    environment:
      # æ•°æ®åº“ä¸ Redis è¿æ¥ï¼ˆåˆ†å¸ƒå¼æ¨¡å¼ï¼?
      - DATABASE_URL=postgresql+asyncpg://kirogate:${PG_PASSWORD:-changeme}@postgres:5432/kirogate
      - REDIS_URL=redis://redis:6379/0

      # å¿…å¡«: ä»£ç†æœåŠ¡å™¨å¯†ç ?
      - PROXY_API_KEY=${PROXY_API_KEY:-change-me-in-production}

      # å¿…å¡«: ç®¡ç†åå°
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change-me-in-production}
      - ADMIN_SECRET_KEY=${ADMIN_SECRET_KEY:-change-me-in-production}

      # å¿…å¡«: ç”¨æˆ·ä¼šè¯ä¸?Token åŠ å¯†ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä¸€è‡´ï¼‰
      - USER_SESSION_SECRET=${USER_SESSION_SECRET:-change-me-in-production}
      - TOKEN_ENCRYPT_KEY=${TOKEN_ENCRYPT_KEY:-change-me-in-production}

      # å¯é€? Kiro è®¤è¯é…ç½®
      - REFRESH_TOKEN=${REFRESH_TOKEN:-}
      - KIRO_CREDS_FILE=${KIRO_CREDS_FILE:-}
      - PROFILE_ARN=${PROFILE_ARN:-}
      - KIRO_REGION=${KIRO_REGION:-us-east-1}

      # å¯é€? OAuth2 ç”¨æˆ·ç™»å½•
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID:-}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-}
      - OAUTH_REDIRECT_URI=${OAUTH_REDIRECT_URI:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-}

      # å¯é€? è¿æ¥æ± é…ç½?
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-10}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-50}

      # å¯é€? Token é˜²é£æ§é…ç½?
      - TOKEN_RPM_LIMIT=${TOKEN_RPM_LIMIT:-10}
      - TOKEN_RPH_LIMIT=${TOKEN_RPH_LIMIT:-200}
      - TOKEN_MAX_CONCURRENT=${TOKEN_MAX_CONCURRENT:-2}
      - TOKEN_MAX_CONSECUTIVE_USES=${TOKEN_MAX_CONSECUTIVE_USES:-5}

      # å¯é€? ç”¨æˆ·é…é¢é…ç½®
      - DEFAULT_USER_DAILY_QUOTA=${DEFAULT_USER_DAILY_QUOTA:-500}
      - DEFAULT_USER_MONTHLY_QUOTA=${DEFAULT_USER_MONTHLY_QUOTA:-10000}
      - DEFAULT_KEY_RPM_LIMIT=${DEFAULT_KEY_RPM_LIMIT:-30}

      # å¯é€? è¶…æ—¶ä¸æ—¥å¿?
      - FIRST_TOKEN_TIMEOUT=${FIRST_TOKEN_TIMEOUT:-45}
      - FIRST_TOKEN_MAX_RETRIES=${FIRST_TOKEN_MAX_RETRIES:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG_MODE=${DEBUG_MODE:-off}

      # å¯é€? é™æ€èµ„æºä»£ç?
      - STATIC_ASSETS_PROXY_ENABLED=${STATIC_ASSETS_PROXY_ENABLED:-true}
      - STATIC_ASSETS_PROXY_BASE=${STATIC_ASSETS_PROXY_BASE:-https://proxy.jhun.edu.kg}

      # NODE_ID ç”±æ¯ä¸ªå®¹å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
    volumes:
      - kirogate_data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # ============================================================
  # Nginx - è´Ÿè½½å‡è¡¡ä¸åå‘ä»£ç?
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: kirogate-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8000}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      kirogate:
        condition: service_healthy

volumes:
  pg_data:
  redis_data:
  kirogate_data:
